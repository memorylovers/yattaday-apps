# テスト戦略

## 概要

本プロジェクトでは、テストピラミッドの考え方に基づき、各層に適したテスト手法を採用することで、効率的かつ包括的な品質保証を実現します。

## テストピラミッド

```
         E2Eテスト
        /         \    (少量・重要な業務フロー)
       /___________\
      /             \   統合テスト
     /_______________\  (中量・層間の連携)
    /                 \ 
   /___________________\ 単体テスト
                         (大量・高速・ロジック中心)
```

### 基本原則

1. **自動化優先**: 可能な限りテストを自動化し、継続的な品質保証を実現
2. **適切な粒度**: 各層の責務に応じた適切なテスト粒度を選択
3. **高速フィードバック**: 単体テストを充実させ、早期の問題発見を促進
4. **保守性重視**: テストコード自体の品質と保守性を重視

## 層別テスト方針

```
┌─────────────────────────────────────────────┐
│          高カバレッジ層                       │
│  models, repository, store, flow, services  │
│      （ビジネスロジック・外部連携）            │
├─────────────────────────────────────────────┤
│           選択的テスト層                      │
│              view_model                     │
│      （複雑なロジックがある場合のみ）           │
├─────────────────────────────────────────────┤
│          ビジュアル確認層                     │
│           component, page                   │
│         （UI中心・視覚的確認）                 │
└─────────────────────────────────────────────┘
```

## 各層のテスト戦略

### Models層（カバレッジ目標: 100%）

**テスト対象:**

- データ構造の生成・変換
- ビジネスロジック
- バリデーション
- 計算処理

**アプローチ:**

- 純粋な単体テスト（外部依存なし）
- すべての公開メソッドをテスト
- 境界値とエッジケースを網羅

### Repository層（カバレッジ目標: 90%）

**テスト対象:**

- CRUD操作
- エラーハンドリング
- データ変換
- 複合処理

**アプローチ:**

- フェイク実装を使用した単体テスト
- エラーケースを重点的にテスト
- データの整合性確認

### Store層（カバレッジ目標: 90%）

**テスト対象:**

- 状態管理ロジック
- ビジネスルール
- 非同期処理
- エラー状態

**アプローチ:**

- 状態遷移の検証
- 並行処理のテスト
- 依存する層はモック化

### Flow層（カバレッジ目標: 85%）

**テスト対象:**

- フロー遷移
- 一時的な状態管理
- ステップ検証
- 完了処理

**アプローチ:**

- シナリオベースのテスト
- 正常系と異常系の両方をカバー

### Services層（カバレッジ目標: 95%）

**テスト対象:**

- 外部ライブラリの正しいラッピング
- エラー変換（統一的な例外処理）
- プロジェクト固有のメソッド
- 型安全性の保証

**アプローチ:**

- 外部ライブラリはモック化
- エラーケースを網羅的にテスト
- 統合的な動作確認

### ViewModel層（複雑なロジックのみ）

**テスト対象:**

- 複雑な画面ロジック
- 状態遷移
- エラーハンドリング
- 非同期処理の組み合わせ

**複雑性の判断基準:**

- 3つ以上の状態を持つ
- 複数の非同期処理を組み合わせる
- 条件分岐が3つ以上
- ビジネスルールを含む

### Component/Page層（ビジュアル確認）

**確認項目:**

- 各種状態での表示
- レスポンシブ対応
- テーマ切り替え
- エラー状態
- ローディング状態

**アプローチ:**

- UIカタログツールでの視覚的確認
- スナップショットテスト（オプション）
- 手動での動作確認

## E2Eテスト戦略

### E2Eテスト戦略の概要

- **目的**: 重要な業務フローの動作確認
- **カバレッジ**: 主要なユーザーシナリオ
- **実行環境**: CI/CD環境

### テスト対象

1. **クリティカルパス**
   - ユーザー登録・ログイン
   - 主要機能の基本操作
   - 決済フロー（該当する場合）

2. **統合シナリオ**
   - 複数機能を跨ぐ操作
   - 外部サービスとの連携

3. **異常系の基本確認**
   - ネットワークエラー
   - 認証エラー
   - データ不整合

### 実行タイミング

- PR作成時（主要フローのみ）
- マージ前（全フロー）
- リリース前（全フロー）

## テストヘルパー

### フェイクオブジェクト

**方針:**

- インターフェースを実装した偽の実装
- テスト用の振る舞いを持つ
- 状態を保持し、検証可能

**利点:**

- 振る舞いが予測可能
- テストが読みやすい
- リファクタリングに強い

### テストデータファクトリ

**方針:**

- ビルダーパターンでテストデータ生成
- デフォルト値を持つ
- ランダムデータ生成サポート

### テストユーティリティ

**提供機能:**

- セットアップ・ティアダウンの共通化
- カスタムマッチャー
- テスト用の拡張メソッド

## カバレッジ測定

### 目標設定

- プロジェクト全体: 80%以上
- ビジネスロジック層: 90%以上
- UI層: カバレッジ測定対象外（ビジュアル確認で代替）

### 継続的な監視

- CI/CDでカバレッジレポート生成
- カバレッジの低下を検知
- 定期的なレビューと改善

## ベストプラクティス

### 1. Arrange-Act-Assert パターン

- **Arrange**: テストの前提条件を設定
- **Act**: テスト対象の動作を実行
- **Assert**: 期待される結果を検証

### 2. 1テスト1検証

- 各テストは1つの振る舞いのみを検証
- テスト名は検証内容を明確に表現
- 失敗時の原因特定が容易

### 3. テストの独立性

- 各テストは他のテストに依存しない
- 実行順序に依存しない
- 並列実行可能

### 4. 読みやすさの重視

- 意図が明確なテストコード
- 適切な抽象化レベル
- ドキュメントとしての役割

### 5. テストの保守性

- DRY原則の適用
- 共通処理の抽出
- テストコードのリファクタリング
