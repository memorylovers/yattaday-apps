# 開発フロー

## 概要

本プロジェクトでは、品質とスピードのバランスを取った「軽量化テスト戦略」を採用しています。  
レイヤーによってテスト手法を使い分けることで、効率的な品質保証を実現します。

## 開発の基本原則

1. **すべてのコマンドは`make`経由で実行** - 環境差異を吸収し、統一的な開発体験を提供
2. **小さなステップで継続的に検証** - 各フェーズ後に`make test`を実行
3. **TDD必須層とUI層で戦略を使い分け** - ビジネスロジックはTDD、UIはWidgetbookで確認

## 開発の基本サイクル

### 1. 計画フェーズ

```bash
# 計画ドキュメントの作成
make plan-new name=<機能名>
```

- `_planning/`ディレクトリに計画ドキュメントを自動作成
- 命名規則: `YYMMDD_HHMM_<説明>.md`
- 実装前に設計を明確化

### 2. 実装フェーズ

#### TDD必須層（ビジネスロジック中心）

**対象**: 1_models, 2_repository, 3_store, 4_flow, services

1. **Red**: テストを先に書く
2. **Green**: 最小限のコードでテストを通す
3. **Refactor**: テストが通る状態を維持しながらコードを改善

#### 柔軟なアプローチ層

**対象**: 5_view_model（複雑なロジックがある場合のみ）

複雑性の判断基準：

- 条件分岐が3つ以上
- 非同期処理の組み合わせ（複数のawait）
- エラーハンドリングが必要
- 状態遷移が複雑（3つ以上の状態）
- ビジネスルールの実装

詳細なテスト実践方法は[テスト戦略](./02_test-strategy.md)を参照してください。

#### UI層（6_component, 7_page）

- UIカタログツールでビジュアル確認
- 各種状態（ローディング、エラー、空状態など）を網羅的に実装

### 3. 品質保証フェーズ

```bash
# すべてのチェックを一度に実行
make check-all

# または個別に実行
make format  # コードフォーマット
make gen     # コード生成（freezed, json_serializable等）
make lint    # 静的解析
make test    # テスト実行
```

## makeコマンドリファレンス

| コマンド | 説明 |
|---------|------|
| `make` | 初期セットアップ（fvm, melos等のインストール） |
| `make format` | コードフォーマット |
| `make gen` | コード生成（freezed, build_runner） |
| `make lint` | 静的解析（Flutter + Markdown） |
| `make test` | テスト実行 |
| `make run` | アプリ実行（staging環境） |
| `make book` | Widgetbook起動 |
| `make check-all` | format → lint → test を順次実行 |
| `make plan-new name=<名前>` | 計画ドキュメント作成 |
| `make e2e` | E2Eテスト実行（Maestro） |

## 完了条件チェックリスト

- [ ] **計画ドキュメントを作成した**: `make plan-new`
- [ ] **TDD対象層はテストファーストで実装した**
- [ ] **UI層はWidgetbookに登録した**
- [ ] **すべてのチェックが通過した**: `make check-all`
  - フォーマット適用済み
  - コード生成が最新
  - テストが全て成功
  - 静的解析エラーなし

## トラブルシューティング

### エラー時の基本対処法

```bash
# 1. コード生成をやり直す
make gen

# 2. それでも解決しない場合は、すべてのチェックを実行
make check-all
```

### よくある問題

- **import エラー**: `make gen`でコード生成をやり直す
- **テスト失敗**: エラーメッセージを確認し、該当箇所を修正
- **Widgetbookが表示されない**: `make book`で再起動

### 詳細なトラブルシューティング

問題が解決しない場合は、以下を参照：

- [アーキテクチャガイド](../01_architecture/02_layered-architecture.md)
- [テスト戦略](./02_test-strategy.md)
- [コーディングスタイル](../03_flutter/05_coding-style.md)

## ベストプラクティス

1. **小さいコミット**: 機能単位で細かくコミット
2. **継続的な実行**: 各実装後に`make test`を実行
3. **早期フィードバック**: プルリクエストは小さく、頻繁に
4. **定期的なリファクタリング**: 技術的負債を溜めない
