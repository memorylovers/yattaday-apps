# CLAUDE.md整合性修正計画

作成日: 2025-06-20 19:02

## 概要

CLAUDE.mdとソースコードの乖離を調査し、整合性を取るための修正計画です。
各TODOを一つずつ実施・レビューしていきます。

## 調査結果サマリー

### Phase 1: メインアプリ (app/lib) の乖離点

#### ディレクトリ構造の相違

1. **番号付きディレクトリが未使用**
   - CLAUDE.md記載: `1_models/`, `2_repository/`, `3_application/`, `4_view_model/`, `5_component/`, `6_page/`
   - 実際: `domain/`, `data/repository/`, `application/`, `presentation/`

2. **servicesディレクトリが存在しない**
   - Firebase等のラッパーは`common/firebase/`や各featureに分散

3. **extentions（スペルミス）**
   - 正しくは`extensions`

#### 実装パターンの相違

- Riverpod Generatorを使用（`@riverpod`アノテーション）
- ドキュメントコメントは適度に存在

### Phase 2: メインアプリのテスト (app/test) の乖離点

#### 存在しないディレクトリ・ファイル

1. **e2eディレクトリ** - 完全に未実装
2. **fixturesディレクトリ** - 存在しない
3. **test_utilsディレクトリ** - 空のまま
4. **test_helpersのサブディレクトリ** (`factories/`, `mocks/`, `builders/`)

#### テストカバレッジの問題

- `record_items`以外のfeatureのテストがほぼ存在しない
- 特に`daily_records`、`home`、`_startup`等の重要機能のテストが欠如

### Phase 3: UIカタログ (widgetbook/lib) の乖離点

#### 欠けているUseCase

1. **多数のコンポーネント**: loading、forms、container等
2. **複数のページ**: foo_page、startup_page
3. **ViewModelモックの不統一**: 一部のページでのみ実装

#### 実装パターンの問題

- Loading/Empty UseCaseがほぼ未実装
- 命名規則の不統一（`build<ComponentName>UseCase`形式が守られていない）

## TODOリスト

### サマリー

- 総TODO数: 45項目
- 高優先度: 15項目
- 中優先度: 24項目
- 低優先度: 6項目

### メインアプリ構造の修正

#### 番号付きディレクトリ構造への段階的移行

- [x] **[高]** record_items: 番号付きディレクトリへの移行 ✅ 2025-06-21
  - domain → 1_models
  - data/repository → 2_repository  
  - application → 3_application
  - presentation → 4_view_model, 5_component, 6_page
- [x] **[高]** daily_records: 番号付きディレクトリへの移行 ✅ 2025-06-21
- [ ] **[中]** account: 番号付きディレクトリへの移行
- [ ] **[中]** _authentication: 番号付きディレクトリへの移行
- [ ] **[中]** home: 番号付きディレクトリへの移行
- [ ] **[低]** _startup: 番号付きディレクトリへの移行
- [ ] **[低]** _force_update: 番号付きディレクトリへの移行
- [ ] **[低]** _app_rate: 番号付きディレクトリへの移行
- [ ] **[低]** _payment: 番号付きディレクトリへの移行
- [ ] **[低]** _advertisement: 番号付きディレクトリへの移行
- [ ] **[低]** settings: 番号付きディレクトリへの移行

#### servicesディレクトリの段階的作成

- [ ] **[高]** servicesディレクトリの基本構造作成
- [ ] **[高]** Firebase関連サービスの移動
  - common/firebase → services/firebase
  - auth_service, firestore_service, analytics_service の作成
- [ ] **[中]** AdMob関連サービスの移動
  - features/_advertisement → services/admob
- [ ] **[中]** RevenueCat関連サービスの移動
  - features/_payment → services/revenue_cat
- [ ] **[低]** SharedPreferences関連サービスの作成
  - services/shared_preferences/storage_service.dart

#### その他の構造修正

- [x] **[低]** extentions→extensionsのスペル修正 ✅ 2025-06-20

### テスト環境の整備

#### 主要機能のテスト追加

- [ ] **[高]** daily_records機能のテスト追加
- [ ] **[高]** home機能のテスト追加
- [ ] **[高]** _startup機能のテスト追加

#### テスト基盤の段階的整備

- [ ] **[中]** test_helpers/factories ディレクトリ作成
  - record_item_factory.dart
  - user_factory.dart
  - test_data_factory.dart
- [ ] **[中]** test_helpers/mocks ディレクトリ作成
  - 既存のfake_record_item_repositoryを移動
  - fake_auth_repository.dart追加
- [ ] **[中]** test_helpers/builders ディレクトリ作成
  - record_item_builder.dart
- [ ] **[中]** fixturesディレクトリとテストデータの追加
  - fixtures/record_items/
  - fixtures/users/
- [ ] **[中]** test_utilsの実装
  - fixture_loader.dart
  - test_data_matcher.dart
- [ ] **[中]** e2eテストディレクトリとMaestro設定の追加

### Widgetbookの補完

#### ViewModelモックの段階的実装

- [ ] **[高]** モック実装のベースパターン作成
- [ ] **[高]** settings_page: ViewModelモック実装
- [ ] **[高]** payment_page: ViewModelモック実装
- [ ] **[中]** login_page: ViewModelモック改善
- [ ] **[中]** record_items系ページ: ViewModelモック改善

#### 欠けているコンポーネントUseCaseの段階的追加

- [ ] **[高]** 基本コンポーネント
  - loading/loading.dart
  - forms/text_fields.dart
- [ ] **[中]** コンテナ・レイアウト系
  - container/ink_well_container.dart
  - scaffold/tab_bar_scaffold.dart
  - scroll/scroll_view_with_bar.dart
- [ ] **[中]** record_items関連ウィジェット
  - record_item_list_view.dart
  - record_item_detail_header.dart
  - record_item_statistics_card.dart
  - record_item_calendar.dart
- [ ] **[低]** その他のコンポーネント
  - floading_action_buttons.dart
  - debug/borders.dart
  - debug/flavor_banner.dart

#### その他のWidgetbook改善

- [ ] **[中]** startup_pageのUseCase追加
- [ ] **[中]** Loading/Error/Empty UseCaseの追加
- [ ] **[低]** 命名規則の統一 (`build<ComponentName>UseCase`)

### ドキュメントの更新

- [ ] **[中]** CLAUDE.md(app): 実際の構造に合わせて更新
- [ ] **[中]** CLAUDE.md(widgetbook): 実際の構造に合わせて更新

## 実施順序（推奨）

1. **即座に修正可能な項目**
   - extentions→extensionsのスペル修正（影響範囲が小さい）

2. **番号付きディレクトリ構造への段階的移行**
   - record_items（最も完全な実装のため、参考モデルとして最初に）
   - daily_records（record_itemsに依存するため、次に）
   - account, _authentication（認証関連）
   - home（メイン機能）
   - その他の機能（優先度順）

3. **servicesディレクトリの段階的作成**
   - servicesディレクトリの基本構造作成
   - Firebase関連サービスの移動
   - AdMob、RevenueCat関連サービスの移動
   - SharedPreferences関連サービスの作成

4. **テストの充実**（優先度の高い機能から）
   - daily_records機能のテスト追加
   - home機能のテスト追加
   - _startup機能のテスト追加

5. **テスト基盤の段階的整備**
   - test_helpers/factories, mocks, builders作成
   - fixturesディレクトリとテストデータの追加
   - test_utilsの実装（fixture_loader, test_data_matcher）
   - e2eテストディレクトリとMaestro設定

6. **Widgetbookの段階的改善**
   - モック実装のベースパターン作成
   - 各ページのViewModelモック実装（settings, payment等）
   - 基本コンポーネントのUseCase追加（loading, forms）
   - レイアウト系・record_items関連のUseCase追加
   - Loading/Error/Empty UseCaseの追加
   - 命名規則の統一

7. **ドキュメントの更新**
   - CLAUDE.md(app)の更新
   - CLAUDE.md(widgetbook)の更新

## 各TODO実施時の注意点

### 番号付きディレクトリ構造への移行

- 既存のimport文の大量修正が必要
- `make gen`による再生成が必要
- 段階的な移行計画を立てる

#### 各featureの移行手順

1. ディレクトリ名の変更
   - `domain` → `1_models`
   - `data/repository` → `2_repository`
   - `application` → `3_application`
   - `presentation` → `4_view_model`, `5_component`, `6_page`に分割
2. import文の一括置換
3. テストディレクトリも同様に変更
4. `make gen`でコード再生成
5. `make test`でテスト確認
6. 他のfeatureへの影響確認（特にapplicationへの参照）

### テストの追加

- TDDの原則に従い、まずテストから作成
- 既存のテストパターンを参考に実装
- モックとフェイクの適切な使い分け

### Widgetbookの改善

- 既存のUseCaseパターンを踏襲
- ViewModelのモック実装を標準化
- 命名規則の統一は最後に一括で実施

## 成功基準

1. すべてのTODOが完了している
2. `make format`、`make gen`、`make lint`、`make test`がすべて成功する
3. CLAUDE.mdと実際のコードが完全に一致している
4. Widgetbookですべてのページ・コンポーネントが確認できる

## 更新履歴

- 2025-06-20 19:02: 初版作成
- 2025-06-20 19:08: TODOリストをチェックボックス形式に変更
- 2025-06-20 19:15: 段階的実施のため、以下のタスクを詳細化
  - 番号付きディレクトリ構造への移行（featureごと）
  - servicesディレクトリの作成（サービスごと）
  - test_helpersのサブディレクトリ構造（種類ごと）
  - ViewModelモック実装（ページごと）
  - コンポーネントUseCase追加（種類ごと）
