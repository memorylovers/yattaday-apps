# CLAUDE.md整合性修正計画

作成日: 2025-06-20 19:02
最終更新: 2025-06-21

## 概要

CLAUDE.mdとソースコードの乖離を調査し、整合性を取るための修正計画です。
各TODOを一つずつ実施・レビューしていきます。

## 未完了TODOリスト

### サマリー

- 総TODO数: 30項目（3項目完了）
- 高優先度: 18項目
- 中優先度: 10項目
- 低優先度: 2項目

### メインアプリ構造の修正

#### feature配下のブラッシュアップ

- [ ] **[高]** ディレクトリ名の修正
  - `_ advertisement` → `_advertisement`（スペースを削除）
- [ ] **[高]** Repository層のProviders移行
  - account/2_repository/account_providers.dart → 3_application/へ移動
  - account/2_repository/profile_providers.dart → 3_application/へ移動
  - FirestoreのCollectionReference等を提供するProviderはapplication層が適切
- [ ] **[高]** settings機能のaccount統合
  - settings/1_models/user_settings.dart → account/1_models/へ移動
  - settingsフィーチャーを削除
  - settings_page.dartとuser_settings.dartを同一featureに統合
- [ ] **[高]** 3_application/の命名規則統一
  - _startup/3_application/startup_provider.dart → startup_store.dart
  - _force_update/3_application/force_update_provider.dart → force_update_store.dart
  - _payment/3_application/payment_provider.dart → payment_store.dart
  - _app_rate/3_application/app_rate_provider.dart → app_rate_store.dart
  - _advertisement/3_application/admob_provider.dart → admob_store.dart
  - _authentication/3_application/auth_providers.dart → auth_store.dart（単数形に）
- [ ] **[高]** 3_application/のサブディレクトリ解消
  - record_items/3_application/providers/ の内容を3_application/直下へ
  - daily_records/3_application/providers/ の内容を3_application/直下へ
  - use_cases/は維持（CLAUDE.mdに記載あり）
- [ ] **[高]** 空ディレクトリの削除
  - homeフィーチャー全体を削除
  - 各featureの空ディレクトリを削除：
    - settings全体、_startup（1_models, 2_repository, 4_view_model）
    - _force_update（1_models, 2_repository, 4_view_model, 5_component）
    - _payment（1_models, 2_repository, 4_view_model, 5_component）
    - _app_rate（2_repository, 4_view_model, 5_component, 6_page）
    - account（3_application, 5_component）

#### servicesディレクトリの段階的作成

- [x] **[中]** AdMob関連サービスの移動 ✅ 2025-06-21
  - ad_consent_helper.dartをad_consent_service.dartに統合
  - グローバル関数からクラスベースのサービスに移行
- [x] **[中]** RevenueCat関連サービスの確認 ✅ 2025-06-21
  - すでに適切に配置済み（services/revenuecat/revenuecat_service.dart）
- [x] **[低]** SharedPreferences関連サービスの確認 ✅ 2025-06-21
  - すでに適切に実装済み（services/shared_preferences/shared_preferences_service.dart）

### テスト環境の整備

#### 主要機能のテスト追加

- [ ] **[高]** daily_records機能のテスト追加
- [ ] **[高]** home機能のテスト追加
- [ ] **[高]** _startup機能のテスト追加

#### テスト基盤の段階的整備

- [ ] **[中]** test_helpers/factories ディレクトリ作成
  - record_item_factory.dart
  - user_factory.dart
  - test_data_factory.dart
- [ ] **[中]** test_helpers/mocks ディレクトリ作成
  - 既存のfake_record_item_repositoryを移動
  - fake_auth_repository.dart追加
- [ ] **[中]** test_helpers/builders ディレクトリ作成
  - record_item_builder.dart
- [ ] **[中]** fixturesディレクトリとテストデータの追加
  - fixtures/record_items/
  - fixtures/users/
- [ ] **[中]** test_utilsの実装
  - fixture_loader.dart
  - test_data_matcher.dart
- [ ] **[中]** e2eテストディレクトリとMaestro設定の追加

### Widgetbookの補完

#### ViewModelモックの段階的実装

- [ ] **[高]** モック実装のベースパターン作成
- [ ] **[高]** settings_page: ViewModelモック実装
- [ ] **[高]** payment_page: ViewModelモック実装
- [ ] **[中]** login_page: ViewModelモック改善
- [ ] **[中]** record_items系ページ: ViewModelモック改善

#### 欠けているコンポーネントUseCaseの段階的追加

- [ ] **[高]** 基本コンポーネント
  - loading/loading.dart
  - forms/text_fields.dart
- [ ] **[中]** コンテナ・レイアウト系
  - container/ink_well_container.dart
  - scaffold/tab_bar_scaffold.dart
  - scroll/scroll_view_with_bar.dart
- [ ] **[中]** record_items関連ウィジェット
  - record_item_list_view.dart
  - record_item_detail_header.dart
  - record_item_statistics_card.dart
  - record_item_calendar.dart
- [ ] **[低]** その他のコンポーネント
  - floading_action_buttons.dart
  - debug/borders.dart
  - debug/flavor_banner.dart

#### その他のWidgetbook改善

- [ ] **[中]** startup_pageのUseCase追加
- [ ] **[中]** Loading/Error/Empty UseCaseの追加
- [ ] **[低]** 命名規則の統一 (`build<ComponentName>UseCase`)

### ドキュメントの更新

- [ ] **[中]** CLAUDE.md(app): 実際の構造に合わせて更新
- [ ] **[中]** CLAUDE.md(widgetbook): 実際の構造に合わせて更新

## 実施順序（推奨）

1. **feature配下のブラッシュアップ**（高優先度）
   - Repository層のProviders移行
   - settings機能のaccount統合
   - 空ディレクトリの削除
   - 命名規則の統一確認

2. **テストの充実**（優先度の高い機能から）
   - daily_records機能のテスト追加
   - home機能のテスト追加
   - _startup機能のテスト追加

3. **テスト基盤の段階的整備**
   - test_helpers/factories, mocks, builders作成
   - fixturesディレクトリとテストデータの追加
   - test_utilsの実装（fixture_loader, test_data_matcher）
   - e2eテストディレクトリとMaestro設定

4. **Widgetbookの段階的改善**
   - モック実装のベースパターン作成
   - 各ページのViewModelモック実装（settings, payment等）
   - 基本コンポーネントのUseCase追加（loading, forms）
   - レイアウト系・record_items関連のUseCase追加
   - Loading/Error/Empty UseCaseの追加
   - 命名規則の統一

5. **ドキュメントの更新**
   - CLAUDE.md(app)の更新
   - CLAUDE.md(widgetbook)の更新

## 各TODO実施時の注意点

### feature配下のブラッシュアップ2

- **ディレクトリ名修正**: `_ advertisement`のスペースを削除
- **Repository層のProviders移行**: FirestoreのCollectionReferenceなどを提供するProviderは3_applicationへ
- **settings統合**: インポートパスの一括置換が必要
- **3_application命名規則**: `_provider.dart` → `_store.dart`への変更、インポートパスの修正必要
- **サブディレクトリ解消**: providers/内のファイルを3_application/直下へ移動
- **空ディレクトリ削除**: 参照がないことを確認してから削除、特にhomeフィーチャー全体

### servicesディレクトリへの移動

- 既存のProviderとの依存関係を考慮
- Service層はpureなDartクラスとして実装（Riverpod依存を削除）
- import文の一括置換が必要

### テストの追加

- TDDの原則に従い、まずテストから作成
- 既存のテストパターンを参考に実装
- モックとフェイクの適切な使い分け

### Widgetbookの改善

- 既存のUseCaseパターンを踏襲
- ViewModelのモック実装を標準化
- 命名規則の統一は最後に一括で実施

## 成功基準

1. すべてのTODOが完了している
2. `make format`、`make gen`、`make lint`、`make test`がすべて成功する
3. CLAUDE.mdと実際のコードが完全に一致している
4. Widgetbookですべてのページ・コンポーネントが確認できる

## 完了した作業

### 2025-06-20

- ✅ extentions→extensionsのスペル修正

### 2025-06-21

- ✅ servicesディレクトリの基本構造作成
- ✅ Firebase関連サービスの実装（AuthService, AnalyticsService, CrashlyticsService）
- ✅ 不要なService削除（FirestoreService, FirebaseService）
- ✅ Firebase SDKインスタンスProviderの削除
- ✅ Service層をpureなDartクラスに変更（Riverpod依存を削除）
- ✅ LocalStorageServiceをSharedPreferencesServiceに名称変更
- ✅ 全feature（record_items, daily_records, account, _authentication, home,_startup, _force_update, _payment,_advertisement, _app_rate, settings）の番号付きディレクトリへの移行完了
- ✅ fooフィーチャーの削除（サンプル画面のため不要）
- ✅ AdMob関連サービスの整理（ad_consent_helperをad_consent_serviceに統合）
- ✅ RevenueCat関連サービスの確認（すでに適切に配置済み）
- ✅ SharedPreferences関連サービスの確認（すでに適切に実装済み）

## 更新履歴

- 2025-06-20 19:02: 初版作成
- 2025-06-20 19:08: TODOリストをチェックボックス形式に変更
- 2025-06-20 19:15: 段階的実施のため、タスクを詳細化
- 2025-06-21: 多数のタスク完了により、未完了タスクのみに整理
